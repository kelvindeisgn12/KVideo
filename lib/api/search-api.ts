import type {
    VideoSource,
    VideoItem,
    ApiSearchResponse,
} from '@/lib/types';
import { fetchWithTimeout, withRetry } from './http-utils';

// --- 終極繁簡轉換機 (精確配對版) ---
// 針對影視搜尋最高頻的繁體字進行一對一精確轉換，保證不漏字！
const T2S_DICT: Record<string, string> = {
    '復': '复', '仇': '仇', '者': '者', '聯': '联', '盟': '盟', '變': '变', '形': '形', '金': '金', '剛': '刚',
    '電': '电', '視': '视', '機': '机', '劇': '剧', '動': '动', '畫': '画', '網': '网', '終': '终', '結': '结',
    '戰': '战', '爭': '争', '龍': '龙', '殺': '杀', '羅': '罗', '亞': '亚', '惡': '恶', '靈': '灵', '魂': '魂',
    '劍': '剑', '傳': '传', '說': '说', '紀': '纪', '元': '元', '異': '异', '世': '世', '界': '界', '魔': '魔',
    '法': '法', '神': '神', '仙': '仙', '情': '情', '緣': '缘', '愛': '爱', '覺': '觉', '醒': '醒', '歡': '欢',
    '迎': '迎', '實': '实', '際': '际', '測': '测', '試': '试', '號': '号', '類': '类', '藝': '艺', '術': '术',
    '總': '总', '體': '体', '驗': '验', '證': '证', '醫': '医', '藥': '药', '廠': '厂', '廣': '广', '場': '场',
    '創': '创', '造': '造', '勢': '势', '態': '态', '導': '导', '演': '演', '員': '员', '響': '响', '應': '应',
    '寶': '宝', '貝': '贝', '買': '买', '賣': '卖', '蟲': '虫', '寵': '宠', '物': '物', '奮': '奋', '鬥': '斗',
    '犧': '牺', '牲': '牲', '獨': '独', '立': '立', '獲': '获', '獎': '奖', '絕': '绝', '對': '对', '補': '补',
    '充': '充', '規': '规', '則': '则', '罰': '罚', '款': '款', '審': '审', '判': '判', '縣': '县', '鄉': '乡',
    '村': '村', '衛': '卫', '生': '生', '豐': '丰', '富': '富', '貧': '贫', '窮': '穷', '遺': '遗', '產': '产',
    '遲': '迟', '鈍': '钝', '鎮': '镇', '壓': '压', '閃': '闪', '躲': '躲', '驚': '惊', '嚇': '吓', '顧': '顾',
    '問': '问', '題': '题', '顛': '颠', '覆': '覆', '驅': '驱', '逐': '逐', '騎': '骑', '士': '士', '髓': '髓',
    '髒': '脏', '髮': '发', '鬍': '胡', '鬚': '须', '鬧': '闹', '鬱': '郁', '魅': '魅', '鮑': '鲍', '鴕': '鸵',
    '鳥': '鸟', '鳶': '鸢', '鳴': '鸣', '鷗': '鸥', '鷹': '鹰', '鹿': '鹿', '麥': '麦', '麵': '面', '麻': '麻',
    '黃': '黄', '黍': '黍', '黑': '黑', '點': '点', '黨': '党', '鼓': '鼓', '鼠': '鼠', '鼻': '鼻', '齊': '齐',
    '齒': '齿', '齡': '龄', '龐': '庞', '龜': '龟', '絡': '络', '線': '线', '纜': '缆', '離': '离', '開': '开',
    '關': '关', '閉': '闭', '鎖': '锁', '鑰': '钥', '匙': '匙', '鐘': '钟', '錶': '表', '釘': '钉', '鉛': '铅',
    '銅': '铜', '銀': '银', '礦': '矿', '釋': '释', '放': '放', '錄': '录', '音': '音', '預': '预', '領': '领',
    '頻': '频', '道': '道', '目': '目', '顏': '颜', '色': '色', '型': '型', '客': '客', '顯': '显', '示': '示',
    '頁': '页', '面': '面', '頂': '顶', '部': '部', '順': '顺', '序': '序', '及': '及', '收': '收', '驟': '骤',
    '然': '然', '驢': '驴', '駱': '骆', '駝': '驼', '騙': '骗', '騰': '腾', '騷': '骚', '骨': '骨', '過': '过',
    '這': '这', '還': '还', '進': '进', '達': '达', '運': '运', '遊': '游', '遠': '远', '遇': '遇', '選': '选',
    '遜': '逊', '遞': '递', '遼': '辽', '邁': '迈', '邊': '边', '邏': '逻', '飛': '飞', '食': '食', '飢': '饥',
    '飯': '饭', '飲': '饮', '飽': '饱', '飾': '饰', '餃': '饺', '餅': '饼', '餓': '饿', '餘': '余', '館': '馆',
    '馬': '马', '駐': '驻', '駕': '驾', '駛': '驶', '魚': '鱼', '魯': '鲁', '鮮': '鲜', '鯉': '鲤', '鯊': '鲨',
    '鯨': '鲸', '鱷': '鳄', '鳳': '凤', '鴨': '鸭', '鵝': '鹅', '鶴': '鹤', '鸚': '鹦', '黽': '黾', '鼇': '鳌',
    '買': '买', '亂': '乱', '僅': '仅', '優': '优', '偉': '伟', '傷': '伤', '價': '价', '儀': '仪', '億': '亿',
    '償': '偿', '兒': '儿', '兩': '两', '內': '内', '冊': '册', '寫': '写', '軍': '军', '農': '农', '凍': '冻',
    '幾': '几', '擊': '击', '劃': '划', '劉': '刘', '勸': '劝', '辦': '办', '務': '务', '勝': '胜', '勞': '劳',
    '區': '区', '華': '华', '協': '协', '單': '单', '盧': '卢', '歷': '历', '厭': '厌', '厲': '厉', '嚴': '严',
    '參': '参', '雙': '双', '發': '发', '敘': '叙', '疊': '叠', '葉': '叶', '嘆': '叹', '吳': '吴', '啟': '启',
    '聽': '听', '啞': '哑', '嚮': '向', '嗎': '吗', '噸': '吨', '週': '周', '圖': '图', '圓': '圆', '國': '国',
    '園': '园', '團': '团', '執': '执', '堅': '坚', '報': '报', '塊': '块', '墜': '坠', '墳': '坟', '壇': '坛',
    '壞': '坏', '壘': '垒', '墾': '垦', '壽': '寿', '夢': '梦', '夾': '夹', '奧': '奥', '妝': '妆', '婦': '妇',
    '媽': '妈', '孫': '孙', '寧': '宁', '寬': '宽', '將': '将', '專': '专', '尋': '寻', '爾': '尔', '塵': '尘',
    '層': '层', '屬': '属', '屢': '屡', '島': '岛', '嶺': '岭', '嶽': '岳', '帥': '帅', '師': '师', '帳': '帐',
    '帶': '带', '幀': '帧', '幫': '帮', '幣': '币', '慶': '庆', '庫': '库', '廢': '废', '棄': '弃', '彌': '弥',
    '彎': '弯', '彈': '弹', '強': '强', '歸': '归', '當': '当', '彙': '汇', '彿': '佛', '後': '后', '徑': '径',
    '從': '从', '微': '微', '徵': '征', '德': '德', '徹': '彻', '心': '心', '憶': '忆', '懺': '忏', '懼': '惧',
    '懸': '悬', '戀': '恋', '戲': '戏', '戶': '户', '拋': '抛', '挾': '挟', '捨': '舍', '掃': '扫', '掛': '挂',
    '採': '采', '探': '探', '接': '接', '控': '控', '推': '推', '掩': '掩', '捷': '捷', '排': '排', '掙': '挣',
    '揚': '扬', '換': '换', '揮': '挥', '損': '损', '搖': '摇', '搗': '捣', '搜': '搜', '搞': '搞', '搬': '搬',
    '搭': '搭', '搶': '抢', '摘': '摘', '摩': '摩', '摸': '摸', '撐': '撑', '撒': '撒', '撞': '撞', '播': '播',
    '撲': '扑', '撈': '捞', '擁': '拥', '擇': '择', '擋': '挡', '操': '操', '擎': '擎', '擔': '担', '據': '据',
    '擠': '挤', '擦': '擦', '擬': '拟', '擴': '扩', '擺': '摆', '擾': '扰', '攝': '摄', '效': '效', '敵': '敌',
    '數': '数', '斂': '敛', '斃': '毙', '斬': '斩', '斷': '断', '斯': '斯', '新': '新', '方': '方', '於': '于',
    '施': '施', '旁': '旁', '旅': '旅', '旋': '旋', '族': '族', '旗': '旗', '無': '无', '既': '既', '日': '日',
    '旦': '旦', '舊': '旧', '旨': '旨', '早': '早', '旬': '旬', '旭': '旭', '時': '时', '會': '会', '書': '书',
    '條': '条', '東': '东', '極': '极', '業': '业', '構': '构', '槍': '枪', '樣': '样', '橋': '桥', '檢': '检',
    '橢': '椭', '權': '权', '止': '止', '正': '正', '此': '此', '步': '步', '武': '武', '歧': '歧', '歪': '歪',
    '歲': '岁', '死': '死', '歿': '殁', '殘': '残', '殖': '殖', '殲': '歼', '殼': '壳', '毀': '毁', '毆': '殴',
    '氣': '气', '氫': '氢', '氧': '氧', '氨': '氨', '氦': '氦', '氟': '氟', '水': '水', '匯': '汇', '漢': '汉',
    '湯': '汤', '溝': '沟', '沒': '没', '澇': '涝', '決': '决', '沖': '冲', '況': '况', '洩': '泄', '洶': '汹',
    '洽': '洽', '派': '派', '流': '流', '濟': '济', '渾': '浑', '濃': '浓', '塗': '涂', '湧': '涌', '濤': '涛',
    '漣': '涟', '渦': '涡', '渙': '涣', '滌': '涤', '潤': '润', '澗': '涧', '漲': '涨', '澀': '涩', '澱': '淀',
    '淵': '渊', '淺': '浅', '減': '减', '港': '港', '渴': '渴', '游': '游', '渺': '渺', '滋': '滋', '溉': '溉',
    '滅': '灭', '燈': '灯', '災': '灾', '爐': '炉', '爛': '烂', '炎': '炎', '炮': '炮', '炸': '炸', '為': '为',
    '烈': '烈', '烏': '乌', '烤': '烤', '焦': '焦', '焰': '焰', '然': '然', '煙': '烟', '煞': '煞', '照': '照',
    '煩': '烦', '煮': '煮', '熊': '熊', '熟': '熟', '熱': '热', '燃': '燃', '燒': '烧', '燕': '燕', '營': '营',
    '燥': '燥', '燦': '灿', '燭': '烛', '爲': '为', '爺': '爷', '牆': '墙', '牽': '牵', '犢': '犊', '狀': '状',
    '猛': '猛', '猜': '猜', '猶': '犹', '猴': '猴', '獅': '狮', '獸': '兽', '獻': '献', '瑪': '玛', '環': '环',
    '現': '现', '瓊': '琼', '疇': '畴', '疆': '疆', '療': '疗', '白': '白', '百': '百', '的': '的', '皆': '皆',
    '皇': '皇', '皮': '皮', '皺': '皱', '盤': '盘', '盲': '盲', '直': '直', '相': '相', '盼': '盼', '盾': '盾',
    '省': '省', '眉': '眉', '看': '看', '真': '真', '眠': '眠', '眼': '眼', '著': '着', '睛': '睛', '睡': '睡',
    '督': '督', '瞞': '瞒', '瞥': '瞥', '瞭': '了', '知': '知', '短': '短', '石': '石', '碼': '码', '破': '破',
    '礎': '础', '碩': '硕', '確': '确', '礙': '碍', '碎': '碎', '碗': '碗', '碟': '碟', '碧': '碧', '碰': '碰',
    '磁': '磁', '磅': '磅', '磨': '磨', '禮': '礼', '社': '社', '祖': '祖', '祥': '祥', '票': '票', '祿': '禄',
    '禁': '禁', '禍': '祸', '福': '福', '禪': '禅', '禿': '秃', '秀': '秀', '私': '私', '秋': '秋', '種': '种',
    '科': '科', '秒': '秒', '秘': '秘', '租': '租', '稱': '称', '移': '移', '程': '程', '稅': '税', '稚': '稚',
    '穩': '稳', '穫': '获', '空': '空', '突': '突', '竊': '窃', '站': '站', '竟': '竟', '章': '章', '童': '童',
    '端': '端', '競': '竞', '竹': '竹', '笑': '笑', '筆': '笔', '笛': '笛', '符': '符', '笨': '笨', '第': '第',
    '等': '等', '筋': '筋', '築': '筑', '答': '答', '策': '策', '籌': '筹', '簽': '签', '簡': '简', '算': '算',
    '管': '管', '箭': '箭', '箱': '箱', '節': '节', '範': '范', '篇': '篇', '籮': '箩', '米': '米', '粉': '粉',
    '粗': '粗', '精': '精', '糖': '糖', '糧': '粮', '系': '系', '糾': '纠', '紂': '纣', '約': '约', '紅': '红',
    '納': '纳', '純': '纯', '紙': '纸', '級': '级', '紛': '纷', '素': '素', '紡': '纺', '索': '索', '緊': '紧',
    '紫': '紫', '累': '累', '細': '细', '紳': '绅', '紹': '绍', '組': '组', '給': '给', '統': '统', '絲': '丝',
    '絹': '绢', '綁': '绑', '綏': '绥', '經': '经', '綜': '综', '綠': '绿', '綢': '绸', '維': '维', '綱': '纲',
    '緒': '绪', '編': '编', '緩': '缓', '緬': '缅', '緯': '纬', '練': '练', '緻': '致', '縈': '萦', '縛': '缚',
    '縫': '缝', '縮': '缩', '縱': '纵', '縷': '缕', '績': '绩', '繁': '繁', '繃': '绷', '繆': '缪', '織': '织',
    '繕': '缮', '繞': '绕', '繪': '绘', '繩': '绳', '繫': '系', '繭': '茧', '繹': '绎', '繼': '继', '續': '续',
    '缺': '缺', '罪': '罪', '置': '置', '署': '署', '罵': '骂', '罷': '罢', '羊': '羊', '美': '美', '羞': '羞',
    '群': '群', '義': '义', '羽': '羽', '翁': '翁', '習': '习', '翔': '翔', '翹': '翘', '翻': '翻', '翼': '翼',
    '耀': '耀', '老': '老', '考': '考', '而': '而', '耍': '耍', '耐': '耐', '耗': '耗', '耳': '耳', '耶': '耶',
    '聊': '聊', '職': '职', '聰': '聪', '聲': '声', '聾': '聋', '肉': '肉', '肚': '肚', '股': '股', '肥': '肥',
    '肩': '肩', '肯': '肯', '育': '育', '背': '背', '胎': '胎', '胖': '胖', '胞': '胞', '胡': '胡', '胸': '胸',
    '能': '能', '脂': '脂', '脅': '胁', '脆': '脆', '脈': '脉', '脊': '脊', '脫': '脱', '脹': '胀', '腐': '腐',
    '腸': '肠', '腹': '腹', '腺': '腺', '腦': '脑', '腫': '肿', '腳': '脚', '膚': '肤', '膠': '胶', '膽': '胆',
    '臂': '臂', '臟': '脏', '臣': '臣', '臥': '卧', '臨': '临', '自': '自', '臭': '臭', '至': '至', '致': '致',
    '臺': '台', '與': '与', '舌': '舌', '舍': '舍', '舒': '舒', '舞': '舞', '舟': '舟', '航': '航', '般': '般',
    '艦': '舰', '船': '船', '良': '良', '艱': '艰', '色': '色', '艷': '艳', '艾': '艾', '芋': '芋', '芒': '芒',
    '芝': '芝', '芬': '芬', '花': '花', '芳': '芳', '蒼': '苍', '蘇': '苏', '苑': '苑', '若': '若', '苦': '苦',
    '英': '英', '茂': '茂', '范': '范', '茅': '茅', '茫': '茫', '茶': '茶', '草': '草', '荒': '荒', '荷': '荷',
    '莉': '莉', '莊': '庄', '莎': '莎', '莫': '莫', '菜': '菜', '菩': '菩', '菱': '菱', '菲': '菲', '萄': '萄',
    '萊': '莱', '萬': '万', '落': '落', '葛': '葛', '葡': '葡', '董': '董', '葦': '苇', '葩': '葩', '葫': '葫',
    '葬': '葬', '蔥': '葱', '葵': '葵', '葷': '荤', '蒂': '蒂', '蒙': '蒙', '蒜': '蒜', '蒲': '蒲', '蒸': '蒸',
    '蓄': '蓄', '蓉': '蓉', '蓋': '盖', '蓑': '蓑', '蓮': '莲', '蔔': '卜', '蔣': '蒋', '蔬': '蔬', '蔭': '荫',
    '蔽': '蔽', '蕃': '蕃', '蕉': '蕉', '蕊': '蕊', '蕎': '荞', '藩': '藩', '藹': '蔼', '藻': '藻', '蘆': '芦',
    '蘋': '苹', '蘊': '蕴', '蘭': '兰', '蘿': '萝', '處': '处', '虛': '虚', '虜': '虏', '虧': '亏', '蛇': '蛇',
    '蛋': '蛋', '蛙': '蛙', '蛛': '蛛', '蛤': '蛤', '蠻': '蛮', '血': '血', '眾': '众', '行': '行', '街': '街',
    '衝': '冲', '衣': '衣', '表': '表', '衰': '衰', '衷': '衷', '袁': '袁', '裂': '裂', '裝': '装', '裕': '裕',
    '褲': '裤', '襪': '袜', '襲': '袭', '西': '西', '要': '要', '見': '见', '覽': '览', '親': '亲', '觀': '观',
    '角': '角', '解': '解', '觸': '触', '言': '言', '訂': '订', '計': '计', '訊': '讯', '討': '讨', '訓': '训',
    '託': '托', '記': '记', '訝': '讶', '訟': '讼', '訣': '诀', '訥': '讷', '訪': '访', '設': '设', '許': '许',
    '訴': '诉', '診': '诊', '註': '注', '証': '证', '詞': '词', '詠': '咏', '詩': '诗', '詰': '诘', '話': '话',
    '該': '该', '詳': '详', '誇': '夸', '誌': '志', '認': '认', '誓': '誓', '誕': '诞', '誘': '诱', '語': '语',
    '誠': '诚', '誤': '误', '說': '说', '誦': '诵', '請': '请', '諸': '诸', '諾': '诺', '讀': '读', '課': '课',
    '誰': '谁', '調': '调', '諒': '谅', '論': '论', '諜': '谍', '謎': '谜', '謙': '谦', '講': '讲', '謝': '谢',
    '謠': '谣', '謬': '谬', '謹': '谨', '譁': '哗', '識': '识', '譜': '谱', '警': '警', '譯': '译', '議': '议',
    '譴': '谴', '護': '护', '譽': '誉', '讚': '赞', '谷': '谷', '豆': '豆', '豬': '猪', '象': '象', '豪': '豪',
    '貌': '貌', '貞': '贞', '負': '负', '財': '财', '貢': '贡', '貨': '货', '販': '贩', '貪': '贪', '貫': '贯',
    '責': '责', '貯': '贮', '貴': '贵', '貸': '贷', '費': '费', '貼': '贴', '貿': '贸', '賀': '贺', '賂': '赂',
    '賃': '赁', '資': '资', '賈': '贾', '賊': '贼', '賓': '宾', '賜': '赐', '賞': '赏', '賠': '赔', '賢': '贤',
    '賤': '贱', '賦': '赋', '質': '质', '賬': '账', '賭': '赌', '賴': '赖', '賺': '赚', '購': '购', '賽': '赛',
    '贈': '赠', '贊': '赞', '贏': '赢', '赤': '赤', '赫': '赫', '走': '走', '起': '起', '超': '超', '越': '越',
    '趕': '赶', '趙': '赵', '趨': '趋', '足': '足', '跌': '跌', '跑': '跑', '距': '距', '跟': '跟', '跨': '跨',
    '路': '路', '跳': '跳', '踏': '踏', '踢': '踢', '踩': '踩', '蹤': '踪', '躍': '跃', '身': '身', '車': '车',
    '軌': '轨', '軒': '轩', '軟': '软', '轉': '转', '軸': '轴', '輕': '轻', '載': '载', '較': '较', '輔': '辅',
    '輛': '辆', '輝': '辉', '輩': '辈', '輪': '轮', '輯': '辑', '輸': '输', '輻': '辐', '輾': '辗', '輿': '舆',
    '辭': '辞', '遷': '迁', '迎': '迎', '運': '运', '近': '近', '返': '返', '違': '违', '連': '连', '迴': '回',
    '遞': '递', '適': '适', '避': '避', '邀': '邀', '邑': '邑', '那': '那', '邦': '邦', '邪': '邪', '郵': '邮',
    '邱': '邱', '邵': '邵', '邸': '邸', '郊': '郊', '郎': '郎', '鄭': '郑', '郭': '郭', '都': '都', '鄂': '鄂',
    '鄙': '鄙', '鄰': '邻', '酉': '酉', '酋': '酋', '酌': '酌', '配': '配', '酒': '酒', '醉': '醉', '醋': '醋',
    '醜': '丑', '醬': '酱', '采': '采', '里': '里', '重': '重', '野': '野', '量': '量', '針': '针', '釣': '钓',
    '鈔': '钞', '鈕': '钮', '鈞': '钧', '鈴': '铃', '鈷': '钴', '鈸': '钹', '鈹': '铍', '鈺': '钰', '錢': '钱',
    '鉗': '钳', '缽': '钵', '鑽': '钻', '鉀': '钾', '鈾': '铀', '鐵': '铁', '鉑': '铂', '鉛': '铅', '鉚': '铆',
    '銅': '铜', '鋁': '铝', '鍘': '铡', '銑': '铣', '銘': '铭', '錚': '铮', '銀': '银', '鑄': '铸', '鋪': '铺',
    '鏈': '链', '銷': '销', '鎖': '锁', '鋤': '锄', '鍋': '锅', '銹': '锈', '鋒': '锋', '鋅': '锌', '銳': '锐',
    '銻': '锑', '銼': '锉', '錫': '锡', '鋼': '钢', '錄': '录', '錐': '锥', '錦': '锦', '錙': '锱', '錯': '错',
    '錨': '锚', '鑼': '锣', '鍛': '锻', '鍍': '镀', '鎂': '镁', '鏤': '镂', '鎘': '镉', '鑷': '镊', '鎳': '镍',
    '鎔': '镕', '鏡': '镜', '鏢': '镖', '鏜': '镗', '鏝': '镘', '鏞': '镛', '鏑': '镝', '鏟': '铲', '鐘': '钟',
    '鏽': '锈', '鑊': '镬', '鑌': '镔', '鑑': '鉴', '鑒': '鉴', '鑠': '铄', '鑤': '刨', '鑪': '炉', '鑰': '钥',
    '鑲': '镶', '長': '长', '門': '门', '閃': '闪', '閉': '闭', '開': '开', '閏': '闰', '閑': '闲', '間': '间',
    '閔': '闵', '閘': '闸', '閣': '阁', '閥': '阀', '閨': '闺', '閩': '闽', '閭': '闾', '閱': '阅', '閹': '阉',
    '閻': '阎', '閼': '阏', '闇': '暗', '闊': '阔', '闋': '阕', '闌': '阑', '闐': '阗', '闔': '阖', '闕': '阙',
    '闖': '闯', '關': '关', '闢': '辟', '防': '防', '阻': '阻', '阿': '阿', '陀': '陀', '附': '附', '陋': '陋',
    '陌': '陌', '降': '降', '限': '限', '院': '院', '陣': '阵', '除': '除', '陪': '陪', '陰': '阴', '陳': '陈',
    '陵': '陵', '陶': '陶', '陷': '陷', '陸': '陆', '陽': '阳', '隆': '隆', '隊': '队', '階': '阶', '隔': '隔',
    '隕': '陨', '障': '障', '隱': '隐', '隸': '隶', '隻': '只', '雋': '隽', '雀': '雀', '雁': '雁', '雄': '雄',
    '雅': '雅', '集': '集', '僱': '雇', '雉': '雉', '雌': '雌', '雍': '雍', '雕': '雕', '雖': '虽', '雜': '杂',
    '雞': '鸡', '離': '离', '難': '难', '雨': '雨', '雪': '雪', '雲': '云', '零': '零', '雷': '雷', '需': '需',
    '震': '震', '霍': '霍', '霎': '霎', '霜': '霜', '霞': '霞', '霧': '雾', '露': '露', '霸': '霸', '霹': '霹',
    '靂': '雳', '青': '青', '靖': '靖', '靜': '静', '非': '非', '靠': '靠', '靡': '靡', '面': '面', '革': '革',
    '靴': '靴', '靶': '靶', '鞋': '鞋', '鞍': '鞍', '鞏': '巩', '韃': '鞑', '鞦': '秋', '韋': '韦', '韌': '韧',
    '韓': '韩', '音': '音', '韻': '韵', '響': '响', '頁': '页', '頂': '顶', '頃': '顷', '項': '项', '順': '顺',
    '須': '须', '煩': '烦', '頓': '顿', '頗': '颇', '領': '领', '頜': '颌', '頰': '颊', '頸': '颈', '頻': '频',
    '顆': '颗', '題': '题', '額': '额', '顎': '颚', '顏': '颜', '願': '愿', '顛': '颠', '類': '类', '顧': '顾',
    '顯': '显', '風': '风', '飄': '飘', '飛': '飞', '食': '食', '飢': '饥', '飯': '饭', '飲': '饮', '飽': '饱',
    '飾': '饰', '餃': '饺', '餅': '饼', '餓': '饿', '餘': '余', '館': '馆', '首': '首', '香': '香', '馬': '马',
    '駐': '驻', '駕': '驾', '駛': '驶', '駝': '驼', '駭': '骇', '駱': '骆', '駿': '骏', '騎': '骑', '騙': '骗',
    '騰': '腾', '騷': '骚', '騾': '骡', '驀': '蓦', '驅': '驱', '驕': '骄', '驚': '惊', '骨': '骨', '高': '高',
    '鬆': '松', '鬍': '胡', '鬚': '须', '鬥': '斗', '鬧': '闹', '鬱': '郁', '鬼': '鬼', '魁': '魁', '魄': '魄',
    '魅': '魅', '魚': '鱼', '魯': '鲁', '鮮': '鲜', '鯉': '鲤', '鯊': '鲨', '鯨': '鲸', '鱷': '鳄', '鳥': '鸟',
    '鳳': '凤', '鳴': '鸣', '鴨': '鸭', '鵝': '鹅', '鶴': '鹤', '鷹': '鹰', '鸚': '鹦', '鹵': '卤', '鹹': '咸',
    '鹽': '盐', '鹿': '鹿', '麗': '丽', '麥': '麦', '麵': '面', '麻': '麻', '麼': '么', '黃': '黄', '黎': '黎',
    '黑': '黑', '默': '默', '點': '点', '黨': '党', '黴': '霉', '黽': '黾', '鼇': '鳌', '鼎': '鼎', '鼓': '鼓',
    '鼠': '鼠', '鼻': '鼻', '齊': '齐', '齋': '斋', '齒': '齿', '齡': '龄', '龍': '龙', '龐': '庞', '龜': '龟'
};

function convertToSimplified(text: string): string {
    if (!text) return text;
    try {
        // 先嘗試解碼 (防止瀏覽器將中文變成 %E5%BE 等 URL 編碼導致無法翻譯)
        const decodedText = decodeURIComponent(text);
        let result = '';
        for (let i = 0; i < decodedText.length; i++) {
            const char = decodedText.charAt(i);
            // 如果字典裡有這個繁體字，就換成簡體；沒有就保持原狀
            result += T2S_DICT[char] || char;
        }
        return result;
    } catch (e) {
        // 如果解碼失敗，直接處理原始文字
        let result = '';
        for (let i = 0; i < text.length; i++) {
            const char = text.charAt(i);
            result += T2S_DICT[char] || char;
        }
        return result;
    }
}
// ------------------------------

/**
 * Search videos from a single source
 */
async function searchVideosBySource(
    query: string,
    source: VideoSource,
    page: number = 1
): Promise<{ results: VideoItem[]; source: string; responseTime: number; pagecount: number }> {
    const startTime = Date.now();

    // 🟢 使用終極翻譯機，將繁體關鍵字轉換為簡體
    const simplifiedQuery = convertToSimplified(query);

    const url = new URL(`${source.baseUrl}${source.searchPath}`);
    url.searchParams.set('ac', 'detail');
    // 🟢 把轉換好的簡體字丟給片源 API
    url.searchParams.set('wd', simplifiedQuery);
    url.searchParams.set('pg', page.toString());

    try {
        const response = await withRetry(async () => {
            const res = await fetchWithTimeout(url.toString(), {
                method: 'GET',
                headers: {
                    'User-Agent': 'Mozilla/5.0',
                    ...source.headers,
                },
                // 🟢 強制不使用 Next.js 快取，確保每次搜尋都能拿到最新結果
                cache: 'no-store',
            });

            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }

            return res;
        });

        const data: ApiSearchResponse = await response.json();

        if (data.code !== 1 && data.code !== 0) {
            throw new Error(data.msg || 'Invalid API response');
        }

        const results: VideoItem[] = (data.list || []).map(item => ({
            ...item,
            source: source.id,
        }));

        return {
            results,
            source: source.id,
            responseTime: Date.now() - startTime,
            pagecount: data.pagecount ?? 1,
        };
    } catch (error) {
        console.error(`Search failed for source ${source.name}:`, error);
        throw {
            code: 'SEARCH_FAILED',
            message: `Failed to search from ${source.name}`,
            source: source.id,
            retryable: true,
        };
    }
}

/**
 * Search videos from multiple sources in parallel
 */
export async function searchVideos(
    query: string,
    sources: VideoSource[],
    page: number = 1
): Promise<Array<{ results: VideoItem[]; source: string; responseTime?: number; pagecount?: number; error?: string }>> {
    const searchPromises = sources.map(async source => {
        try {
            return await searchVideosBySource(query, source, page);
        } catch (error) {
            return {
                results: [],
                source: source.id,
                error: error instanceof Error ? error.message : 'Unknown error',
            };
        }
    });

    return Promise.all(searchPromises);
}
